# 现代战舰战斗录制器 v1.0

一个专为现代战舰游戏设计的战斗操作录制工具，支持实时录制各种游戏操作并**同时执行真实的ADB控制操作**，实现边玩边录制的功能。

## 功能特色

- 🎮 **实时录制+控制** - 录制时同步执行ADB操作，实现真实的游戏控制体验
- ⚡ **智能操作识别** - 自动识别快速点击、长按等不同操作模式，精确记录时长
- 🖥️ **双界面模式** - 提供GUI图形界面和Rich美化的终端界面
- 📱 **ADB设备控制** - 通过ADB连接安卓设备进行实时操作控制
- ⌨️ **智能按键映射** - 将键盘按键实时映射到游戏操作，操作简单直观
- 📊 **详细统计分析** - 提供操作统计、按键使用频率等分析功能
- 💾 **录制保存加载** - 支持录制结果的保存和加载，便于重复使用
- 🔄 **连续控制优化** - 长按操作使用连续短按实现流畅控制体验
- 🚀 **防重复执行** - 智能防抖机制，避免过度频繁的ADB操作
- **双录制模式支持**：支持PC端录制（船体操控）和ADB端录制（武器等其他操作）
- **实时录制控制**：边玩边录制，真实操控手机设备
- **预设长按系统**：支持9种预设长按时长（100ms-900ms），通过Ctrl+数字键切换
- **双回放模式支持**：支持PC端回放和手机端回放，满足不同需求
- **长按补偿机制**：手机端回放时自动增加150ms补偿，确保操作准确性
- **多界面支持**：提供GUI图形界面、Rich美化终端界面和独立回放器
- **文件合并功能**：可将PC端和ADB端录制文件合并为完整的操作序列
- **详细统计分析**：提供录制统计、动作分析和时间轴显示
- **并发回放机制**：避免累积延迟，确保操作时间精确

## 操作模式详解

### 快速多次点击
- **支持场景**：武器连发、快速转向等
- **识别机制**：按键按下时间 < 150ms 自动识别为快速点击
- **录制效果**：每次点击都会被单独记录，包含精确的时间间隔
- **ADB执行**：每次点击都会发送独立的触摸指令
- **防抖保护**：10ms内的重复按键会被忽略，避免误触

### 任意时长长按
- **支持场景**：持续转向、长时间瞄准等
- **识别机制**：按键按下时间 ≥ 150ms 自动识别为长按
- **录制效果**：记录长按开始时间、结束时间和实际持续时长
- **ADB执行**：使用sendevent直接控制触摸事件，实现真实的按下/抬起操作
- **真实长按**：键盘按下时ADB开始长按，键盘抬起时ADB结束长按，完全同步

### 视角控制
- **支持场景**：战斗中的视角调整
- **操作方式**：方向键控制视角方向，Z/X键切换速度模式
- **防频繁执行**：100ms内的重复视角操作会被合并
- **双速模式**：慢速(200ms)和快速(100ms)两种滑动速度

## 工作原理

本工具采用**边录制边控制**的工作模式：

1. **键盘监听** - 实时监听用户的键盘输入
2. **动作录制** - 将按键操作转换为游戏动作并记录时间戳
3. **ADB执行** - 同步向连接的安卓设备发送对应的触摸/滑动指令
4. **实时反馈** - 用户可以看到游戏中的实际操作效果
5. **数据保存** - 录制完成后保存操作序列供后续分析或重放

这意味着在录制过程中，你实际上是在**真实地控制游戏**，而不是空录制！

## 系统要求

- Python 3.7+
- Windows 10/11 (主要测试平台)
- 安卓设备 (启用USB调试)
- ADB工具 (Android SDK)
- 稳定的USB连接 (用于实时控制)

## 安装步骤

### 1. 克隆项目
```bash
git clone <repository-url>
cd AgentScript
```

### 2. 安装依赖
```bash
pip install -r requirements.txt
```

或手动安装：
```bash
pip install rich PyQt5 keyboard pynput opencv-python numpy
```

### 3. 安装ADB工具
- 下载Android SDK Platform Tools
- 将ADB添加到系统PATH环境变量
- 验证安装：`adb version`

### 4. 连接安卓设备
- 在设备上启用"开发者选项"
- 启用"USB调试"
- 连接设备到电脑
- 验证连接：`adb devices`

## 使用方法

### 1. 环境准备

确保已安装所有依赖：
```bash
pip install -r requirements.txt
```

确保ADB工具可用并且设备已连接：
```bash
adb devices
```

### 2. 启动方式

#### GUI界面（推荐）
```bash
python main.py --mode gui
```

#### 终端界面
```bash
python main.py --mode terminal
```

#### PC端回放
```bash
python main.py --mode pc-replay
python main.py --mode pc-replay --file recording/example.json
```

#### 手机端回放（新功能）
```bash
python main.py --mode mobile-replay
python main.py --mode mobile-replay --file recording/example.json --device YOUR_DEVICE_ID --compensation 200
```

参数说明：
- `--file`: 指定录制文件路径（可选，不指定会列出文件供选择）
- `--device`: 指定目标设备ID（可选，不指定会自动选择或列出设备）
- `--compensation`: 长按补偿时间，单位毫秒，默认150ms

### 3. 录制操作

#### 按键映射

**移动控制**：
- `W` - 前进（点按）
- `S` - 后退（点按）
- `A` - 左转（长按，支持预设时长）
- `D` - 右转（长按，支持预设时长）

**武器发射**：
- `1` - 1号武器（点按）
- `2` - 2号武器（点按）
- `3` - 3号武器（点按）
- `4` - 4号武器（点按）

**特殊功能**：
- `Q` - 回血（点按）
- `E` - 热诱弹（点按）

**视角控制**：
- `Z` - 切换到慢速视角模式
- `X` - 切换到快速视角模式
- `方向键` - 控制视角方向（滑动）

**预设长按**：
- `Ctrl + 1-9` - 切换左右转向预设长按时长（100ms-900ms）

### 4. 录制模式

#### ADB模式（手机端录制）
- 录制所有操作并同时在手机上执行
- 适合录制完整的游戏操作
- 需要连接ADB设备

#### PC模式（电脑端录制）
- 只录制船体操控操作（WSAD和视角控制）
- 不执行ADB操作，仅记录按键
- 适合配合ADB模式使用

### 5. 回放功能

#### PC端回放
- 直接在PC上模拟按键操作
- 适合回放PC端录制的文件
- 支持窗口自动激活和按键发送
- 使用Windows API确保游戏能接收按键

#### 手机端回放（新功能）
- 通过ADB在手机上回放录制的操作
- 支持所有类型的录制文件回放
- **自动长按补偿**：长按操作自动增加150ms（可调整）
- 并发执行，避免累积延迟
- 3秒准备时间，可随时按Ctrl+C停止

#### 长按补偿机制
手机端回放时，所有长按操作（持续时间>100ms）会自动增加补偿时间：
- 默认补偿：150ms
- 可通过参数调整：`--compensation 200`
- 界面中可实时设置：输入 `c200` 设置为200ms
- 补偿范围：0-1000ms

### 6. 文件操作

#### 保存录制
录制完成后可保存为JSON格式文件，包含：
- 设备信息
- 录制时长
- 动作详情
- 时间戳信息
- **自动合并信息**（如果使用了PC回放）

#### 加载录制
可加载之前保存的录制文件继续编辑或回放。

#### 自动合并功能（新特性）
当在ADB录制过程中使用了PC回放文件时，保存录制会自动执行智能合并：

1. **时间戳穿插合并**：PC动作和ADB动作按时间戳顺序穿插排列
2. **长按智能分割**：如果PC的长按被ADB的短按打断，自动将长按分割为多段
3. **来源标记**：每个动作都标记来源（'pc' 或 'adb'）
4. **无需手动操作**：完全自动化，保存时即完成合并

##### 长按分割示例
```
原始PC长按: 5.0s-8.0s (3秒长按)
ADB短按: 6.0s, 7.2s
分割结果:
- PC长按段1: 5.0s-6.0s (1秒)
- ADB短按: 6.0s
- PC长按段2: 6.0s-7.2s (1.2秒)  
- ADB短按: 7.2s
- PC长按段3: 7.2s-8.0s (0.8秒)
```

##### 合并文件格式
```json
{
  "device_id": "设备ID",
  "pc_replay_file": "使用的PC回放文件路径",
  "auto_merged": true,
  "adb_actions_count": 15,
  "pc_actions_count": 8,
  "total_actions": 23,
  "actions": [
    {
      "type": "long_press",
      "source": "pc",
      "split_part": 1,
      "original_duration": 3000,
      "duration": 1000,
      "timestamp": 5.0
    },
    {
      "type": "tap", 
      "source": "adb",
      "timestamp": 6.0
    }
  ]
}
```

### 7. 高级功能

#### 统计分析
- 总动作数和录制时长
- 动作类型分布统计
- 按键使用频率统计
- 最近动作实时显示
- **合并统计信息**（PC/ADB动作计数）

#### 实时监控
- 录制状态实时显示
- 当前按下的按键显示
- 视角模式状态显示
- 录制时间和动作计数
- **PC回放状态显示**

#### 错误处理
- 自动检测ADB连接状态
- 设备断开自动提示
- 录制异常自动恢复
- 文件操作错误提示
- **合并过程错误保护**

## 回放器使用指南

### 手机端回放器（mobile_replayer.py）

独立的手机端回放工具，可单独运行：

```bash
python mobile_replayer.py
```

功能特点：
- **文件选择**：自动扫描recording目录下的JSON文件
- **设备管理**：自动检测连接的设备，支持多设备选择
- **补偿设置**：可动态调整长按补偿时间
- **实时控制**：回放过程中可随时停止
- **状态显示**：显示文件信息、设备状态、补偿设置

操作指令：
- 输入数字：选择对应文件进行回放
- `d + 数字`：选择设备（如 d1 选择第1个设备）
- `c + 数字`：设置长按补偿（如 c200 设置为200ms）
- `s`：停止当前回放
- `r`：刷新文件列表
- `q`：退出程序

### PC端回放器（pc_replayer.py）

独立的PC端回放工具：

```bash
python pc_replayer.py
```

功能特点：
- **游戏窗口检测**：自动查找并激活游戏窗口
- **按键模拟**：使用Windows API直接发送按键
- **权限检查**：检测管理员权限并提示
- **测试功能**：提供按键测试功能

## 故障排除

### 常见问题

1. **设备连接问题**
   ```bash
   adb devices  # 检查设备连接
   adb kill-server && adb start-server  # 重启ADB服务
   ```

2. **权限问题**
   - 确保已启用USB调试
   - 确保已授权计算机调试权限
   - PC回放需要管理员权限

3. **长按操作不准确**
   - 调整长按补偿时间
   - 检查设备性能和网络延迟
   - 尝试不同的补偿值（100-300ms）

4. **回放时间不同步**
   - 检查录制文件的时间戳
   - 确保设备性能稳定
   - 避免在高负载时进行回放

5. **按键无响应（PC回放）**
   - 确保游戏窗口处于活动状态
   - 检查是否以管理员权限运行
   - 尝试使用测试按键功能验证

### 日志和调试

程序运行时会输出详细的操作日志：
- 录制动作的详细信息
- ADB命令执行状态
- 错误和异常信息
- 性能统计数据

## 技术实现

### 核心组件

1. **ActionRecorder**: 动作录制器，负责记录和管理所有操作
2. **KeyboardListener**: 键盘监听器，处理按键事件转换
3. **ADBHelper**: ADB通信模块，处理设备操作
4. **PCReplayer**: PC端回放器，模拟PC按键操作
5. **MobileReplayer**: 手机端回放器，通过ADB回放操作

### 数据格式

录制文件采用JSON格式存储：
```json
{
  "device_id": "设备ID",
  "total_duration": 录制总时长,
  "total_actions": 动作总数,
  "created_time": "创建时间",
  "actions": [
    {
      "type": "动作类型",
      "key": "按键",
      "position": [x, y],
      "timestamp": 时间戳,
      "duration": 持续时间
    }
  ]
}
```

### 长按补偿算法

手机端回放时的长按补偿机制：
```python
if duration > 100:  # 持续时间>100ms认为是长按
    compensated_duration = duration + compensation_ms
    # 执行补偿后的长按操作
```

这确保了在不同设备和网络环境下长按操作的准确性。

## 项目结构

```
AgentScript/
├── main.py                 # 主启动脚本
├── gui_interface.py        # PyQt5图形界面
├── terminal_interface.py   # Rich终端界面
├── action_recorder.py      # 动作录制器核心
├── keyboard_listener.py    # 键盘监听器 + ADB控制
├── game_config.py         # 游戏配置文件
├── ADBHelper.py           # ADB辅助工具 (增强版)
├── requirements.txt       # 依赖包列表
├── recording/             # 录制文件存储目录 (自动创建)
└── README.md             # 项目说明文档
```

## 配置说明

### 游戏坐标配置 (game_config.py)

如果需要适配不同分辨率或游戏版本，可以修改`game_config.py`中的坐标配置：

```python
# 移动控制坐标
MOVEMENT_CONTROLS = {
    'up': (237, 807),      # 上 - 点按
    'down': (680, 813),    # 下 - 点按  
    'left': (442, 702),    # 左 - 连续短按
    'right': (442, 917)    # 右 - 连续短按
}

# 武器发射坐标
WEAPON_CONTROLS = {
    '1': (2049, 717),   # 1号武器
    '2': (1977, 842),   # 2号武器
    '3': (2050, 982),   # 3号武器
    '4': (2240, 987)    # 4号武器
}
```

### 控制参数配置

```python
# 默认参数
DEFAULT_PARAMS = {
    'tap_duration': 50,         # 默认点按持续时间(毫秒)
    'long_press_duration': 500, # 默认长按持续时间(毫秒)
    'swipe_duration': 300,      # 默认滑动持续时间(毫秒)
    'view_swipe_distance': 300, # 视角滑动距离
    'continuous_press_interval': 50,  # 连续短按间隔(毫秒)
    'continuous_press_duration': 100  # 连续短按持续时间(毫秒)
}
```

## 录制文件格式

录制结果保存为JSON格式，包含以下信息：

```json
{
  "device_id": "设备ID",
  "total_duration": "录制总时长",
  "total_actions": "动作总数",
  "created_time": "创建时间",
  "actions": [
    {
      "type": "动作类型",
      "key": "触发按键",
      "position": [x, y],
      "timestamp": "时间戳",
      "duration": "持续时间",
      "executed": true  // 标记是否已执行ADB操作
    }
  ]
}
```

## 故障排除

### 常见问题

1. **找不到设备**
   - 检查USB调试是否启用
   - 确认ADB驱动正确安装
   - 运行`adb devices`验证连接

2. **控制延迟过高**
   - 检查USB连接质量
   - 关闭其他占用ADB的程序
   - 尝试重新连接设备

3. **键盘监听不工作**
   - 确保程序以管理员权限运行
   - 检查keyboard库是否正确安装
   - 某些安全软件可能阻止键盘监听

4. **游戏操作不准确**
   - 检查游戏分辨率是否匹配配置
   - 调整`game_config.py`中的坐标设置
   - 确保游戏界面完全可见且无遮挡

5. **ADB操作失败**
   - 检查设备是否保持连接
   - 确认游戏处于前台运行状态
   - 查看终端输出的错误信息

### 性能优化建议

1. **减少延迟**
   - 使用高质量USB数据线
   - 关闭设备上的省电模式
   - 确保电脑性能充足

2. **提高稳定性**
   - 定期检查设备连接状态
   - 避免在录制过程中切换应用
   - 保持设备电量充足

### 调试模式

启用详细日志输出：
```bash
python main.py --terminal --debug
```

## 安全说明

- 本工具仅供学习和研究使用
- 请遵守相关法律法规和游戏使用条款
- 不建议在竞技模式中使用
- 使用时请注意保护个人隐私和账号安全

## 开发说明

### 添加新的操作类型

1. 在`game_config.py`中添加新的坐标配置
2. 在`keyboard_listener.py`中添加按键处理逻辑和ADB执行代码
3. 在`action_recorder.py`中添加录制方法
4. 更新界面显示相关代码

### 自定义界面

- GUI界面：修改`gui_interface.py`
- 终端界面：修改`terminal_interface.py`
- 样式配置：通过CSS样式表或Rich样式配置

## 许可证

本项目仅供学习和研究使用，请遵守相关法律法规和游戏使用条款。

## 贡献

欢迎提交Issue和Pull Request来改进项目。

## 联系方式

如有问题或建议，请通过Issue页面联系。

## 录制模式

本工具支持两种录制模式，可以分别录制不同类型的操作，最后合并成完整的战斗录制：

### ADB模式 (手机端录制)
- **适用场景**：录制所有游戏操作，包括武器发射、特殊功能等
- **工作方式**：通过ADB连接手机，实时发送触摸指令
- **录制内容**：所有按键操作都会同步执行到手机上
- **设备要求**：需要连接安卓设备并启用USB调试

### PC模式 (电脑端录制)
- **适用场景**：专门录制船体操控动作(WASD + 视角控制)
- **工作方式**：只录制按键序列，不发送ADB指令
- **录制内容**：仅包含移动控制和视角控制操作
- **设备要求**：只需要电脑，无需连接手机

## 使用流程

### 推荐流程：ADB录制 + PC回放自动合并
1. **准备PC端录制文件**
   ```bash
   python main.py --mode pc-replay
   ```
   - 先录制好船体操控动作
   - 保存为PC录制文件

2. **ADB录制 + 自动合并**
   ```bash
   python main.py --mode adb
   ```
   - 连接手机设备
   - 开始录制时选择加载PC录制文件
   - PC动作会在后台回放，同时录制ADB动作
   - 保存时自动合并两个录制，无需手动操作

3. **直接使用合并文件**
   - 保存的文件已经是完整的合并版本
   - 可直接用于回放或分析

### 传统流程：单独录制
- 直接使用ADB模式录制所有操作
- 适合简单场景

## 自动合并技术细节

### 合并算法
1. **时间戳对齐**：所有动作按统一时间基准排序
2. **冲突检测**：识别PC长按与ADB短按的时间重叠
3. **智能分割**：将重叠的长按按中断点分割
4. **最小段过滤**：过滤掉过短（<50ms）的分割段
5. **来源标记**：保持动作来源的可追溯性

### 分割策略
- **长按检测**：持续时间>100ms的操作认为是长按
- **中断识别**：ADB动作时间戳在PC长按期间即为中断
- **段长限制**：分割后的段必须≥50ms才保留
- **时间戳继承**：分割段继承正确的时间戳位置

### 数据完整性
- **原始数据保留**：记录原始长按时长
- **分割信息记录**：标记分割段序号
- **文件关联**：记录使用的PC回放文件路径
- **统计信息**：分别统计PC和ADB动作数量

## 录制模式对比

| 特性 | PC模式 | ADB模式 |
|------|--------|---------|
| 设备需求 | 仅需电脑 | 需要连接手机 |
| 录制内容 | 仅船体操控 | 所有操作 |
| 实时控制 | 无 | 有 |
| 操作响应 | 无延迟 | 有网络延迟 |
| 适用场景 | 预录制船体动作 | 完整战斗录制 |

## 文件合并功能

合并功能会将PC端和ADB端的录制文件按时间戳排序，生成统一的操作序列：

```json
{
  "device_id": "设备ID",
  "pc_file": "PC端录制文件路径",
  "adb_file": "ADB端录制文件路径", 
  "total_duration": "总时长",
  "total_actions": "总动作数",
  "pc_actions_count": "PC端动作数",
  "adb_actions_count": "ADB端动作数",
  "merged": true,
  "actions": [
    {
      "type": "动作类型",
      "source": "pc|adb",  // 标记动作来源
      "timestamp": "时间戳",
      ...
    }
  ]
}
```

## 文件管理

### 录制文件存储
- 所有录制文件默认保存在 `AgentScript/recording/` 文件夹中
- 程序启动时会自动创建此文件夹
- 文件对话框默认打开此目录，方便文件管理

### 文件命名规则
- **录制文件**: `recording_YYYYMMDD_HHMMSS.json`
- **合并文件**: `merged_recording_YYYYMMDD_HHMMSS.json`
- **导出文件**: `actions_YYYYMMDD_HHMMSS.csv` 