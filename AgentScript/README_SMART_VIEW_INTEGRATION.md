# 智能视角功能 - 战舰代肝脚本集成说明

## 功能概述

智能视角功能已集成到现代战舰代肝脚本中，可以在自动战斗回放过程中智能调整视角控制，避免视角移动到错误方向。

## 使用方法

### 1. 准备模板图片

将敌舰或目标的图片保存到以下任一路径：

```
AgentScript/
├── enemy_ship.png                           # 直接放在脚本目录
├── templates/enemy_ship.png                 # 放在templates目录
├── templates/smart_view/enemy_ship.png      # 智能视角专用目录
└── templates/smart_view/target.png          # 其他目标模板
```

**推荐使用路径**：`AgentScript/templates/enemy_ship.png`

### 2. 启动代肝脚本

1. 运行 `warship_auto_battle.py`
2. 在界面中配置以下参数：
   - **设备**: 选择你的Android设备
   - **回放文件**: 选择录制的战斗回放文件
   - **智能视角延迟(s)**: 设置延迟时长（默认2秒，设为0禁用）

### 3. 自动启用

当你点击"开始运行"时，脚本会：
1. 自动检测可用的模板图片
2. 如果找到模板，自动启用智能视角功能
3. 在日志中显示启用状态和模板数量

## 工作原理

### 智能决策逻辑

- **回放30秒后启用**：避免影响开局操作
- **提前500毫秒检测**：在视角操作执行前500毫秒开始图像识别，确保有足够时间做出决策
- **立即取消机制**：如果检测到敌舰在相应区域，立即取消视角操作，避免视角移开目标
- **左侧检测**：如果敌舰在屏幕左侧60%区域，取消"向右"的视角操作
- **右侧检测**：如果敌舰在屏幕右侧60%区域，取消"向左"的视角操作

### 日志信息

启动时会看到类似的日志：
```
[12:34:56] 找到智能视角模板: templates/enemy_ship.png
[12:34:56] 智能视角已启用，模板数量: 1, 延迟: 2.0秒
[12:34:56] 自动战斗已启动
```

回放中会看到：
```
[12:35:26] 智能视角预检测: view_right (提前500ms检测)
[12:35:26] 智能视角: 敌舰在左侧，取消向右视角操作（保持对准目标）
```

## 配置参数

### 界面配置

- **智能视角延迟(s)**: 
  - 范围：0-10秒
  - 0表示禁用智能视角
  - 推荐值：2-3秒（注意：此参数现在主要用于启用/禁用功能，实际使用预检测机制）

### 高级配置（代码中）

如需更精细的控制，可在代码中调整：

```python
# 在setup_smart_view方法中
delay_duration = self.config.get("smart_view_delay", 2.0)  # 延迟时长
```

```python
# 在mobile_replayer.py的detect_template_in_regions方法中
if max_val_left > 0.7:  # 匹配阈值，0.7 = 70%相似度
```

## 模板图片要求

### 图片规格
- **格式**: PNG格式（推荐）
- **尺寸**: 50x50 到 200x200 像素
- **内容**: 敌舰的特征部分，如舰体轮廓、炮塔等

### 制作建议
1. 截取敌舰的特征部分（不需要整个舰体）
2. 选择容易识别的部分（如炮塔、舰桥等）
3. 避免包含过多背景元素
4. 确保图片清晰，无模糊

## 使用场景

### 适合的战斗类型
- **远程炮击战**：需要保持对敌舰的视角锁定
- **追击战**：避免视角偏离目标
- **多敌舰战斗**：优先保持对主要威胁的视角

### 不适合的场景
- **近距离格斗**：快速机动时智能视角可能反应不够快
- **多目标混战**：可能产生误判
- **夜战或恶劣天气**：图像识别准确性下降

## 故障排除

### 常见问题

1. **未启用智能视角**
   ```
   [12:34:56] 未找到智能视角模板，智能视角功能未启用
   ```
   **解决方案**: 确保模板图片存在于指定路径

2. **检测不准确**
   ```
   [12:35:26] 在左侧区域检测到模板: enemy_ship.png (匹配度: 0.650)
   ```
   **解决方案**: 
   - 如果匹配度过低（<0.7），更换更清晰的模板图片
   - 如果误检过多，选择更具特征性的模板

3. **延迟时间不合适**
   **解决方案**: 根据战斗节奏调整"智能视角延迟(s)"参数

### 调试方法

1. **查看日志**: 观察控制台输出的检测信息
2. **调整延迟**: 从2秒开始，根据效果调整
3. **优化模板**: 多次截取不同角度的敌舰图片进行测试

## 性能影响

- **CPU使用**: 增加约10-20%的CPU使用率
- **内存使用**: 增加约50-100MB内存使用
- **检测延迟**: 每次检测约0.1-0.5秒

建议在性能较好的设备上使用，或适当降低检测频率。

## 更新说明

- **v1.0**: 基础智能视角功能
- **v1.1**: 集成到代肝脚本，支持GUI配置
- 后续计划：多模板支持、自适应阈值、区域自定义 