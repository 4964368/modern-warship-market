# 全自动开火系统使用说明

> 📚 **新手必读**：如果你是第一次使用，建议先阅读 [快速启动指南](快速启动指南.md) 了解基础配置流程。

## 功能概述

全自动开火系统是战舰代肝脚本的智能化扩展，可以在回放过程中自动识别敌舰并进行精确射击。

### 核心功能

- **智能目标识别**：按优先级识别蓝色血条、船体轮廓、敌方阵营图标
- **自动镜头校准**：根据目标位置自动调整视角，将目标移动到屏幕中心
- **精确自动射击**：自动发射1、2、3号武器，每轮连续射击2次，共2轮（总计12次射击）
- **智能搜索**：未发现目标时自动转向搜索

## 工作原理

### 目标检测优先级

1. **蓝色血条**（最高优先级）
   - 使用HSV颜色空间检测蓝色血条
   - 检测到后立即校准并开火
   - 无需模板文件，自动颜色识别

2. **船体轮廓**（中等优先级）
   - 使用模板匹配检测敌舰船体
   - 校准后再次检测是否有蓝色血条
   - 需要 `ship_hull.png` 模板文件

3. **敌方阵营图标**（最低优先级）
   - 检测敌方阵营标识进行初步定位
   - 校准后继续搜索其他目标
   - 需要 `enemy_faction.png` 模板文件

### 射击逻辑

```
检测循环 (每0.5秒) -> 发现目标 -> 校准视角 -> 自动开火
    |                                           |
    v                                           v
未发现目标 -> 搜索转向 (向右大幅转向)         开火完成 -> 继续检测
```

### 开火模式

- **武器顺序**：1号 -> 2号 -> 3号武器
- **射击方式**：每个武器连续点击2次
- **射击轮数**：总共2轮
- **总射击次数**：2武器 × 3发 × 2轮 = 12次射击
- **射击间隔**：0.1秒

## 使用方法

### 1. 准备模板文件

在 `AgentScript/templates/auto_fire/` 目录下放置以下模板图片：

#### 必需文件：
- **enemy_faction.png**：敌方阵营图标
  - 截取敌方标识的清晰图片
  - 建议尺寸：50×50 到 100×100 像素

#### 推荐文件：
- **ship_hull.png**：敌舰船体轮廓
  - 截取敌舰船体的特征部分
  - 建议尺寸：100×100 到 200×200 像素

#### 可选文件：
- **blue_health_bar.png**：蓝色血条样本
  - 系统主要使用颜色检测，此为备用
  - 截取典型的蓝色血条图片

### 2. 启用自动开火

1. **运行代肝脚本**：
   ```bash
   cd AgentScript
   py warship_auto_battle.py
   ```

2. **配置自动开火**：
   - 勾选"启用自动开火"复选框
   - 设置"开火延迟(s)"（推荐30-60秒）
   - 配置其他回放参数

3. **开始运行**：
   - 点击"开始运行"
   - 系统会在回放开始后指定秒数启动自动开火

### 3. 运行监控

启用后，日志中会显示：

```
[12:34:56] 自动开火系统已启动，将在30秒后开始
[12:35:26] 自动开火等待30秒后开始...
[12:35:26] 自动开火系统开始工作
[12:35:27] 检测到目标: blue_health_bar at (1350, 400)
[12:35:27] 目标偏离中心 (70, -320)，距离: 327.6像素，开始校准
[12:35:27] 执行校准滑动: (1280, 720) -> (1140, 1360), 时长: 163ms
[12:35:28] 开始自动开火
[12:35:28] 第1轮开火
[12:35:28] 发射1号武器 (第1次)
[12:35:28] 发射1号武器 (第2次)
[12:35:29] 发射2号武器 (第1次)
[12:35:29] 发射2号武器 (第2次)
[12:35:29] 发射3号武器 (第1次)
[12:35:29] 发射3号武器 (第2次)
[12:35:29] 第2轮开火
[12:35:30] 自动开火完成
```

## 配置参数

### 界面配置

- **启用自动开火**：勾选启用/禁用自动开火功能
- **开火延迟(s)**：回放开始后多少秒启动自动开火（0-120秒）

### 高级配置

可以通过修改 `auto_fire_system.py` 中的配置：

```python
self.config = {
    "start_delay": 30.0,           # 开始延迟（秒）
    "detection_interval": 0.5,     # 检测间隔（秒）
    "aim_tolerance": 50,           # 瞄准容忍度（像素）
    "weapon_fire_rounds": 2,       # 每轮武器发射次数
    "weapon_fire_interval": 0.1,   # 武器发射间隔（秒）
    "search_turn_duration": 1000,  # 搜索转向时长（毫秒）
    "calibration_sensitivity": 2.0 # 校准灵敏度倍数
}
```

## 截图技巧

### 模板图片要求

1. **清晰度**：确保图片清晰，无模糊
2. **特征性**：选择具有代表性的特征部分
3. **简洁性**：避免包含过多背景干扰
4. **格式**：PNG格式，保持透明度信息

### 推荐截图区域

- **敌方阵营图标**：截取完整的阵营标识
- **船体轮廓**：截取敌舰的特征部分（如舰桥、炮塔等）
- **蓝色血条**：截取典型的血条样本（可选）

## 注意事项

1. **模板文件**：至少需要 `enemy_faction.png` 才能正常工作
2. **性能影响**：自动开火会增加CPU使用率和截屏频率
3. **兼容性**：与智能视角功能兼容，可同时使用
4. **安全性**：系统会在战斗结束时自动停止

## 故障排除

### 常见问题

1. **无法检测到目标**
   - 检查模板文件是否存在
   - 确认模板图片质量
   - 调整检测阈值

2. **校准不准确**
   - 调整 `calibration_sensitivity` 参数
   - 检查 `SCREEN_CENTER` 配置是否正确

3. **开火频率过高/过低**
   - 调整 `detection_interval` 间隔
   - 修改 `weapon_fire_interval` 参数

### 调试模式

可以通过查看日志输出来诊断问题：
- 目标检测结果
- 校准执行情况
- 开火执行状态
- 错误信息

## 更新日志

- **v1.0**：基础自动开火功能
  - 支持蓝色血条、船体轮廓、敌方阵营图标检测
  - 自动镜头校准和武器射击
  - 智能搜索转向功能 